function _typeof(a){"@babel/helpers - typeof";if("function"==typeof Symbol&&"symbol"==typeof Symbol.iterator){_typeof=function(a){return typeof a}}else{_typeof=function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a}}return _typeof(a)}define ("mod_astra/aplus_chapter",["jquery","core/event","./aplus_poll","theme_boost/bootstrap/dropdown","./aplus_modal"],function(a,b){"use strict";a=function(a){return a&&a.__esModule?a:{default:a}}(a);b=d(b);function c(a){if("function"!=typeof WeakMap)return null;var b=new WeakMap,d=new WeakMap;return(c=function(a){return a?d:b})(a)}function d(a,b){if(!b&&a&&a.__esModule){return a}if(null===a||"object"!==_typeof(a)&&"function"!=typeof a){return{default:a}}var d=c(b);if(d&&d.has(a)){return d.get(a)}var e={},f=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var g in a){if("default"!=g&&Object.prototype.hasOwnProperty.call(a,g)){var h=f?Object.getOwnPropertyDescriptor(a,g):null;if(h&&(h.get||h.set)){Object.defineProperty(e,g,h)}else{e[g]=a[g]}}}e.default=a;if(d){d.set(a,e)}return e}(function(){if("function"==typeof window.CustomEvent)return!1;function a(a,b){var c=b.bubbles!==void 0?b.bubbles:!1,d=b.cancelable!==void 0?b.cancelable:!1,e=b.detail!==void 0?b.detail:void 0,f=document.createEvent("CustomEvent");f.initCustomEvent(a,c,d,e);return f}a.prototype=window.Event.prototype;window.CustomEvent=a})();(function(a,b,c){var d={chapter_url_attr:"data-aplus-chapter",exercise_url_attr:"data-aplus-exercise",active_element_attr:"data-aplus-active-element",loading_selector:"#loading-indicator",quiz_success_selector:"#quiz-success",message_attr:{load:"data-msg-load",submit:"data-msg-submit",error:"data-msg-error"},modal_selector:"#page-modal"};function e(b,c){this.dom_element=b;this.element=a(b);this.settings=a.extend({},d,c);this.ajaxForms=!1;this.url=null;this.modalElement=null;this.loader=null;this.messages=null;this.quizSuccess=null;this.aeOutputs={};this.init()}a.extend(e.prototype,{init:function init(){this.ajaxForms=c.FormData?!0:!1;this.url=this.element.attr(this.settings.chapter_url_attr);this.modalElement=a(this.settings.modal_selector);this.loader=a(this.settings.loading_selector);this.messages=this.readMessages();this.quizSuccess=a(this.settings.quiz_success_selector);this.element.find("["+this.settings.active_element_attr+"='in']").aplusExercise(this,{input:!0});var b=this.element.find("["+this.settings.exercise_url_attr+"]");if(0<b.length){this.dom_element.dispatchEvent(new CustomEvent("aplus:chapter-loaded",{bubbles:!0}));b.aplusExercise(this);this.exercises=b;this.exercisesIndex=0;this.exercisesSize=b.length;this.nextExercise()}else{this.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-loaded",{bubbles:!0,detail:{type:"text/x.aplus-exercise"}}));this.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-ready",{bubbles:!0,detail:{type:"text/x.aplus-exercise"}}))}},nextExercise:function nextExercise(){if(this.exercisesIndex<this.exercisesSize){this.exercises.eq(this.exercisesIndex).aplusExerciseLoad();this.exercisesIndex++}this.dom_element.dispatchEvent(new CustomEvent("aplus:chapter-ready",{bubbles:!0}))},readMessages:function readMessages(){var a={};for(var b in this.settings.message_attr){a[b]=this.loader.attr(this.settings.message_attr[b])}return a},cloneLoader:function cloneLoader(){return a(this.settings.loading_selector).clone().removeAttr("id").show()},openModal:function openModal(a){this.modalElement.aplusModal("open",a)},modalError:function modalError(a){this.modalElement.aplusModal("error",a)},modalContent:function modalContent(a){this.modalElement.aplusModal("content",{content:a});this.renderMath()},modalSuccess:function modalSuccess(a,b){var c=this.quizSuccess.clone().attr("class",a.attr("class")).removeClass("exercise").removeAttr("id").show();c.find(".badge-placeholder").empty().append(b);if(b.hasClass("badge-success")||b.hasClass("badge-warning")){c.find(".btn-success").css("display","block")}else{c.find(".btn-success").hide()}this.modalContent(c)},renderMath:function renderMath(){b.notifyFilterContentUpdated(this.settings.modal_selector)}});a.fn.aplusChapter=function(b){return this.each(function(){if(!a.data(this,"plugin_aplusChapter")){a.data(this,"plugin_aplusChapter",new e(this,b))}})}})(a.default,b,window,document);(function(a,b,c){var d={quiz_attr:"data-aplus-quiz",ajax_attr:"data-aplus-ajax",message_selector:".progress-bar",content_element:"<div class=\"exercise-content\"></div>",content_selector:".exercise-content",exercise_selector:"#exercise-all",summary_selector:".exercise-summary",response_selector:".exercise-response",navigation_selector:"ul.exercise-nav a[class!=\"dropdown-toggle\"]",dropdown_selector:"ul.exercise-nav .dropdown-toggle",last_submission_selector:"ul.exercise-nav .dropdown-menu a:first-child",active_element_attr:"data-aplus-active-element",ae_result_selector:".ae_result",input:!1,submission_point_badges_selector:"[data-points-badge] .badge"};function e(b,c,e){this.dom_element=b;this.element=a(b);this.chapter=c;this.settings=a.extend({},d,e);this.url=null;this.quiz=!1;this.ajax=!1;this.active_element=!1;this.loader=null;this.messages={};this.init()}a.extend(e.prototype,{init:function init(){this.chapterID=this.element.attr("id");this.url=this.element.attr(this.chapter.settings.exercise_url_attr);this.quiz=this.element.attr(this.settings.quiz_attr)!==void 0;this.ajax=this.element.attr(this.settings.ajax_attr)!==void 0;this.active_element=this.element.attr(this.settings.active_element_attr)!==void 0;this.exercise_type=this.quiz?"text/x.aplus-exercise.quiz.v1":this.ajax?"text/x.aplus-exercise.iframe.v1":this.active_element?"text/x.aplus-exercise.active-element.v1":"text/x.aplus-exercise";if(this.active_element&&!this.settings.input)this.chapter.aeOutputs[this.chapterID]=this;this.loader=this.chapter.cloneLoader();this.element.height(this.element.height()).empty();this.element.append(this.settings.content_element);this.element.append(this.loader);if(this.settings.input)this.load();if(!this.active_element&&this.ajax){var b=this;c.addEventListener("message",function(c){if("a-plus-refresh-stats"===c.data.type){a.ajax(b.url,{dataType:"html"}).done(function(c){b.updateSummary(a(c))})}})}},makeInputForm:function makeInputForm(b,c,d,e){var f=a("<div>");f.attr("id","exercise-all");var g=a("<form>");g.attr("action","");g.attr("method","post");var h=a("<div>");h.attr("class","form-group");var i=a("<label>");i.attr("class","control-label");i.attr("for",b+"_input");i.html(c);var j;if(!d||"clickable"===d){j=a("<textarea>");j.val(e)}else if("file"===d){j=a("<input>");j.attr("type","file");g.attr("enctype","multipart/form-data")}else if("dropdown"==d.substring(0,8)){j=a("<select>");var k=d.split(":").pop().split(",");a.each(k,function(b,c){var d=a("<option>");d.text(c);d.val(c);j.append(d)})}j.attr("class","form-control");j.attr("id",b+"_input_id");j.attr("name",b+"_input");var l=a("<div>");h.attr("class","form-group");var m=a("<input>");m.attr("class","btn btn-primary");m.attr("value","Submit");m.attr("type","submit");a(h).append(i,j);a(l).append(m);a(g).append(h,l);a(f).append(g);return a(f)},load:function load(b){this.showLoader("load");var c=this;if(c.settings.input){var d=c.element.data("title"),e=c.element.data("type"),f=c.element.data("default");if(!d)d="";if(!f)f="";c.hideLoader();var g=c.makeInputForm(c.chapterID,d,e,f);c.update(g);c.loadLastSubmission(g);if(!b)c.chapter.nextExercise()}else{a.ajax(this.url,{dataType:"html"}).fail(function(){c.showLoader("error");if(!b)c.chapter.nextExercise()}).done(function(d){c.hideLoader();c.update(a(d));if(c.quiz||c.active_element){c.loadLastSubmission(a(d))}else{c.renderMath();if(!b)c.chapter.nextExercise()}})}},update:function update(b){var c=this;b=b.filter(c.settings.exercise_selector).contents();var d=c.element.find(c.settings.content_selector).empty().append(b).hide();this.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-loaded",{bubbles:!0,detail:{type:this.exercise_type}}));if(c.active_element){var e="";if(c.element.attr("data-title"))e="<p><b>"+c.element.attr("data-title")+"</b></p>";c.element.find(c.settings.summary_selector).remove();a(e).prependTo(c.element.find(c.settings.response_selector))}d.show();var f=c.element.css("height");if(c.active_element){if(c.settings.input){a("#"+c.chapterID+" textarea").css("height",f)}else{if("undefined"!=typeof a("#"+c.chapterID).data("scale")){var g=a(c.settings.ae_result_selector,c.element)[0].scrollHeight;a(c.settings.ae_result_selector,c.element).css({height:g+"px"})}else{a(c.settings.ae_result_selector,c.element).css("height",f)}}}this.element.height("auto");this.bindNavEvents();this.bindFormEvents(d);this.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-ready",{bubbles:!0,detail:{type:this.exercise_type}}))},bindNavEvents:function bindNavEvents(){this.element.find(this.settings.navigation_selector).aplusModalLink();this.element.find(this.settings.dropdown_selector).dropdown();this.element.find(".page-modal").aplusModalLink()},bindFormEvents:function bindFormEvents(a){if(!this.ajax){var b=a.find("form").attr("action",this.url),d=this;if(this.chapter.ajaxForms){b.on("submit",function(a){a.preventDefault();d.submit(this)})}}c.postMessage({type:"a-plus-bind-exercise",id:this.chapterID},"*")},submitAjax:function submitAjax(b,c,d,e){var f=this;a.ajax(b,{type:"POST",data:c,contentType:!1,processData:!1,dataType:"html"}).fail(function(g){e=e||0;if(200!==g.status&&5>e){setTimeout(function(){f.submitAjax(b,c,d,e+1)},100)}if(!f.active_element){f.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-submission-failure",{bubbles:!0,detail:{type:f.exercise_type}}));f.chapter.modalError(f.chapter.messages.error)}else{var h=a("<div>");h.attr("id","feedback");h.append(f.chapter.messages.error);f.updateOutput(h)}}).done(function(a){d(a)})},collectFormData:function collectFormData(b){b=a(b);var c=this.matchInputs(b),d=c[0],e=c[1],f=c[2],g=new FormData,h=this.chapterID,j=!0;a.each(e,function(b,c){var d,e=a.find("#"+c),i=a("#"+c+"_input_id");if(e[0].hasAttribute("data-inputs")){if(a(e).data("evaluating")){j=!1;g=!1;return}d=a(e).find(".ae_result").text().trim()}else if("file"===a(e).data("type")){d=i.get(0).files[0]}else if(c!==h){d=i.val();if(a(e).data("value"))d=a(e).data("value");i.val(d)}else{d=i.val();a(e).data("value",d)}if(!d)j=!1;if(g)g.append(f[b],d)});return[d,j,g]},submit:function submit(b){var c=this,d=this.chapter;if(this.active_element){var e=this.chapterID,f=a.find("[data-inputs~=\""+e+"\"]");a.each(f,function(d,e){var f=c.collectFormData(e,b),g=f[0],h=f[1],i=f[2],j=g.chapterID,k=a("#"+j),l=k.find(g.settings.ae_result_selector);if(!h&&!i){return}if(!h){a("#"+j).find(g.settings.ae_result_selector).html("<p style=\"color:red;\">Fill out all the inputs</p>");c.dom_element.dispatchEvent(new CustomEvent("aplus:submission-aborted",{bubbles:!0,detail:{type:c.exercise_type}}));return}k.data("evaluating",!0);if("undefined"!=typeof k.data("scale")){l.css({height:l.height()})}l.html("<p>Evaluating</p>");var m=g.url;g.submitAjax(m,i,function(b){var c=a(b);if(!c.find(".alert-danger").length){var d=c.find(".exercise-wait"),e=d.attr("data-poll-url"),f=d.attr("data-ready-url");k.attr("data-poll-url",e);k.attr("data-ready-url",f);g.updateSubmission(c)}else if(0<=c.find(".alert-danger").contents().text().indexOf("The grading queue is not configured.")){k.find(g.settings.ae_result_selector).html(c.find(".alert").text());k.find(g.settings.ae_result_selector).append(c.find(".grading-task").text())}else{k.find(g.settings.ae_result_selector).html(c.find(".alert-danger").contents())}})})}else{d.openModal(d.messages.submit);var g=this,h=a(b).attr("action"),i=new FormData(b);g.submitAjax(h,i,function(b){var c=a(b);if(g.quiz){var e=c.find(".badge").eq(2).clone();g.update(c);d.modalSuccess(g.element,e);g.renderMath();g.dom_element.dispatchEvent(new CustomEvent("aplus:submission-finished",{bubbles:!0,detail:{type:g.exercise_type}}))}else{g.updateSubmission(c)}})}},matchInputs:function matchInputs(b){var c=b.attr("id"),d=this.chapter.aeOutputs[c],e=b.attr("data-inputs").split(" "),f=b.find(d.settings.ae_result_selector).attr("data-expected-inputs");if(f){f=f.trim().split(" ");f=a.grep(f,function(b){return""!==b||"\n"!==b})}else{f=[]}return[d,e,f]},updateSummary:function updateSummary(a){this.element.find(this.settings.summary_selector).empty().append(a.find(this.settings.summary_selector).remove().contents());this.bindNavEvents()},updateSubmission:function updateSubmission(b){if(!this.active_element){this.updateSummary(b);this.chapter.modalContent(b.filter(this.settings.exercise_selector).contents())}if("function"==typeof a.aplusExerciseDetectWaits){var c=this,d;if(this.active_element)d="#"+this.chapterID;var e=a.aplusExerciseDetectWaits(function(b,d){if(d){if(c.active_element){c.dispatchEventToActiveElem("aplus:exercise-submission-failure")}else{c.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-submission-failure",{bubbles:!0,detail:{type:c.exercise_type}}));c.load(!0)}return}a.ajax(b).done(function(b){if(c.active_element){c.updateOutput(b);c.dispatchEventToActiveElem("aplus:submission-finished");c.submit()}else{var d=a(b),e=d.find(c.settings.submission_point_badges_selector),f=c.element.find(c.settings.summary_selector+" .badge");f.eq(0).replaceWith(e.eq(0).clone());f.eq(2).replaceWith(e.eq(1).clone());var g=d.filter(c.settings.exercise_selector).contents();if(""==g.text().trim()){c.chapter.modalSuccess(c.element,e.eq(1).clone())}else{c.chapter.modalContent(g)}c.dom_element.dispatchEvent(new CustomEvent("aplus:submission-finished",{bubbles:!0,detail:{type:c.exercise_type}}));c.load(!0)}}).fail(function(){c.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-submission-failure",{bubbles:!0,detail:{type:c.exercise_type}}));c.chapter.modalError(c.chapter.messages.error);c.load(!0)})},d);if(!e){c.load(!0)}}},updateOutput:function updateOutput(b){var c=this,d=c.element.attr("data-type")||"text",e=a(b);if(!e.is("#feedback")){e=e.find("#feedback")}if("text"==d){e=e.text()}else if("image"==d){e="<img src=\"data:image/png;base64, "+e.text()+"\" />"}var f=c.element.find(c.settings.ae_result_selector);f.html(e);c.element.data("evaluating",!1);if("undefined"!=typeof c.element.data("scale")){f.css({height:"auto"})}},updateInputs:function updateInputs(b){b=b.submission_data;var c=this,d=c.matchInputs(c.element),e=d[0],f=d[1],g=d[2];for(var h in b){if(!b.hasOwnProperty(h)){continue}var i=f[a.inArray(h,g)],j=b[h];if("file"!==a("#"+i).data("type")){a(a.find("#"+i)).data("value",j);a("#"+i+"_input_id").val(j).trigger("change")}}},dispatchEventToActiveElem:function dispatchEventToActiveElem(b){this.dom_element.dispatchEvent(new CustomEvent(b,{bubbles:!0,detail:{type:this.exercise_type}}));for(var c=this.matchInputs(this.element),d=c[1],e=0;e<d.length;++e){var f=d[e],g=a("#"+f).data("plugin_aplusExercise");if(g){g.dom_element.dispatchEvent(new CustomEvent(b,{bubbles:!0,detail:{type:g.exercise_type}}))}}},loadLastSubmission:function loadLastSubmission(b){var c=b.find(this.settings.last_submission_selector),d=this;if(0<c.length){var e=c.attr("href");if(e&&"#"!==e){var f="html";if(d.active_element){var g=e.match(/submission\.php\?id=(\d+)$/);if(g){e="submission_data.php?id="+g[1];f="json"}else{console.error("Can not read the submission data URL")}}this.showLoader("load");a.ajax(e,{dataType:f}).fail(function(){d.showLoader("error")}).done(function(b){d.hideLoader();if(!d.active_element){d.element.find(d.settings.response_selector).empty().append(a(b).filter(d.settings.exercise_selector).contents());d.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-loaded",{bubbles:!0,detail:{type:d.exercise_type}}));d.bindFormEvents(d.element);d.dom_element.dispatchEvent(new CustomEvent("aplus:exercise-ready",{bubbles:!0,detail:{type:d.exercise_type}}))}else{d.updateOutput(b.feedback);d.updateInputs(b)}d.renderMath()})}else{d.renderMath()}}d.chapter.nextExercise()},showLoader:function showLoader(a){this.loader.show().find(this.settings.message_selector).text(this.chapter.messages[a]);if("error"==a){this.loader.removeClass("progress-bar-animated").addClass("bg-danger")}else{this.loader.addClass("progress-bar-animated").removeClass("bg-danger")}},hideLoader:function hideLoader(){this.loader.hide()},renderMath:function renderMath(){b.notifyFilterContentUpdated("#"+this.element.attr("id"))}});a.fn.aplusExercise=function(b,c){return this.each(function(){if(!a.data(this,"plugin_aplusExercise")){a.data(this,"plugin_aplusExercise",new e(this,b,c))}})};a.fn["aplusExerciseLoad"]=function(){return this.each(function(){var b=a.data(this,"plugin_aplusExercise");if(b){b.load()}})}})(a.default,b,window,document);(function(a){a(document).on("aplus:exercise-loaded",function(b){a(b.target).find("form").each(function(){var b=a(this);if("post"==b.prop("method")){b.on("submit",function(){a(this).find("[type=\"submit\"]").prop("disabled",!0).attr("data-aplus-submit-disabled","yes")})}})});a(document).on("aplus:exercise-submission-failure aplus:submission-finished aplus:submission-aborted",function(b){a(b.target).find("[data-aplus-submit-disabled]").prop("disabled",!1).removeAttr("data-aplus-submit-disabled")});a(document).on("hidden.bs.modal",function(){a("[data-aplus-submit-disabled]").prop("disabled",!1).removeAttr("data-aplus-submit-disabled")})})(a.default)});
//# sourceMappingURL=aplus_chapter.min.js.map
