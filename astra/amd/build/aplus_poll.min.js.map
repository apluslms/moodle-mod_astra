{"version":3,"sources":["../src/aplus_poll.js"],"names":["$","window","defaults","poll_url_attr","ready_url_attr","poll_delays","message_selector","message_attr","error","timeout","AplusExercisePoll","element","callback","options","settings","extend","url","count","init","prototype","show","attr","schedule","poll","poller","ajax","dataType","fail","message","ready","done","data","trim","is","length","setTimeout","get","removeData","ready_url","location","messageType","find","removeClass","text","res_elem","height","addClass","fn","each","aplusExerciseDetectWaits","selector","$selector","aplusExercisePoll","jQuery","document"],"mappings":"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","sourcesContent":["/**\n * Submission status poller from A+. It polls Moodle about the status of\n * a submission, i.e., if it has been graded yet. The JS code is wrapped\n * into an ES6 module for Moodle.\n * \n * In an HTML page, run the following JS code once to activate it:\n * // Initialize the submission status poller\n * // if $(\".exercise-wait\") is the poller element in the page\n * jQuery(function() { jQuery.aplusExerciseDetectWaits(); });\n * // otherwise\n * jQuery(function() { $(\".elementselector\").aplusExercisePoll(callback); });\n * \n * Source: A+ (a-plus/exercise/static/exercise/poll.js)\n * License: GNU GPL v3\n * \n * @module mod_astra/aplus_poll\n */\nimport jQuery from 'jquery';\n\n/**\n * Polling for exercise status.\n *\n */\n;(function($, window, document, undefined) {\n\t\"use strict\";\n\n\tvar pluginName = \"aplusExercisePoll\";\n\tvar defaults = {\n\t\tpoll_url_attr: \"data-poll-url\",\n\t\tready_url_attr: \"data-ready-url\", // new: not in A+ version\n\t\tpoll_delays: [2,3,5,5,5,10,10,10,10],\n\t\tmessage_selector: \".progress-bar\",\n\t\tmessage_attr: {\n\t\t\terror: \"data-msg-error\",\n\t\t\ttimeout: \"data-msg-timeout\"\n\t\t}\n\t};\n\n\tfunction AplusExercisePoll(element, callback, options) {\n\t\tthis.element = $(element);\n\t\tthis.callback = callback;\n\t\tthis.settings = $.extend({}, defaults, options);\n\t\tthis.url = null;\n\t\tthis.count = 0;\n\t\tthis.init();\n\t}\n\n\t$.extend(AplusExercisePoll.prototype, {\n\n\t\t/**\n\t\t * Constructs contained exercise elements.\n\t\t */\n\t\tinit: function() {\n\t\t\tthis.element.show();\n\t\t\tthis.url = this.element.attr(this.settings.poll_url_attr);\n\t\t\tthis.schedule();\n\t\t},\n\n\t\tpoll: function(firstTime) {\n\t\t\tvar poller = this;\n\t\t\t$.ajax(this.url, {dataType: \"html\"})\n\t\t\t\t.fail(function() {\n\t\t\t\t\tpoller.message(\"error\");\n\t\t\t\t\tpoller.ready(true);\n\t\t\t\t})\n\t\t\t\t.done(function(data) {\n\t\t\t\t\tpoller.count++;\n\t\t\t\t\tif (data.trim() === \"ready\" || data.trim() === \"error\" || data.trim() === \"unofficial\") {\n\t\t\t\t\t\tpoller.ready();\n\t\t\t\t\t} else if (poller.element.is(\":visible\")) {\n\t\t\t\t\t\tif (poller.count < poller.settings.poll_delays.length) {\n\t\t\t\t\t\t\tpoller.schedule();\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tpoller.message(\"timeout\");\n\t\t\t\t\t\t\tpoller.ready(true);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t},\n\n\t\tschedule: function() {\n\t\t\tvar poller = this;\n\t\t\tsetTimeout(function() { poller.poll(); },\n\t\t\t\tthis.settings.poll_delays[this.count] * 1000);\n\t\t},\n\n\t\tready: function(error) {\n\t\t\t// If there were no errors, the error parameter is undefined.\n\t\t\t//this.element.hide();\n\n\t\t\t// For active elements the element to which the poll plugin is attached remains the same, so to\n\t\t\t// be able to submit the same form several times the plugin data needs to be removed when the\n\t\t\t// evaluation and polling is finished.\n\t\t\tif ($.data(this.element.get(0), \"plugin_\" + pluginName)) $.removeData(this.element.get(0), \"plugin_\" + pluginName);\n\n\t\t\t//var suburl = this.url.substr(0, this.url.length - \"poll/\".length); // changed from A+\n\t\t\t// added a data attribute for reading the final target URL since in Moodle it can not be a substring of the poll URL\n\t\t\tvar ready_url = this.element.attr(this.settings.ready_url_attr);\n\t\t\tif (this.callback) {\n\t\t\t\tthis.callback(ready_url, error);\n\t\t\t} else {\n\t\t\t\twindow.location = ready_url;\n\t\t\t}\n\t    },\n\n\t\tmessage: function(messageType) {\n\t\t\tthis.element.find(this.settings.message_selector).removeClass(\"progress-bar-animated\")\n\t\t\t\t.text(this.element.attr(this.settings.message_attr[messageType]));\n\t\t\tif (this.element.attr('data-aplus-active-element')) {\n\t\t\t\tvar message = \"There was an error while evaluating the element.\";\n\t\t\t\tif (messageType == \"timeout\") {\n\t\t\t\t\tmessage = \"Evaluation was timed out.\";\n\t\t\t\t}\n\t\t\t\tvar res_elem = this.element.find(\".ae_result\").text(message);\n\t\t\t\tif (res_elem.height() === 0) res_elem.height(\"auto\");\n\t\t\t\tif ($.data(this.element.get(0), \"plugin_\" + pluginName)) {\n\t\t\t\t\t$.removeData(this.element.get(0), \"plugin_\" + pluginName);\n\t\t\t\t}\n\t\t\t} else if (messageType == \"error\") {\n\t\t\t\tthis.element.find(this.settings.message_selector).addClass(\"bg-danger\");\n\t\t\t}\n\t\t},\n\t});\n\n\t$.fn[pluginName] = function(callback, options) {\n\t\treturn this.each(function() {\n\t\t\tif (!$.data(this, \"plugin_\" + pluginName)) { // This apparently blocks re-polling for a same exercise multiple times\n\t\t\t\t$.data(this, \"plugin_\" + pluginName, new AplusExercisePoll(this, callback, options));\n\t\t\t}\n\t\t});\n\t};\n\n\t$.aplusExerciseDetectWaits = function(callback, selector) {\n\t\tselector = selector || \".exercise-wait\";\n\t\tvar $selector = $(selector);\n\t\tif ($selector.length) {\n\t\t\t$selector.aplusExercisePoll(callback);\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t};\n\n})(jQuery, window, document);\n\n"],"file":"aplus_poll.min.js"}